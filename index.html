<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kertases Pro V14.1 - Visionary Stable</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Inter:wght@300;400;500;600&family=Roboto+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #0a0f1d;
            --panel: rgba(21, 32, 54, 0.8);
            --border: rgba(255, 255, 255, 0.08);
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --success: #10b981;
            --danger: #f43f5e;
            --warning: #f59e0b;
            --text: #f8fafc;
            --text-dim: #64748b;
        }

        * { box-sizing: border-box; outline: none; transition: 0.15s ease; }
        body, html {
            margin: 0; padding: 0; font-family: 'Inter', sans-serif;
            background-color: var(--bg); color: var(--text);
            height: 100vh; overflow: hidden;
            background-image: 
                radial-gradient(circle at 10% 10%, rgba(99, 102, 241, 0.12) 0%, transparent 40%),
                radial-gradient(circle at 90% 90%, rgba(16, 185, 129, 0.08) 0%, transparent 40%);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        /* UI Elements */
        .glass-panel { background: var(--panel); backdrop-filter: blur(16px); border: 1px solid var(--border); border-radius: 16px; }
        .cyber-input { background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 10px; color: #fff; padding: 10px 14px; font-size: 0.85rem; width: 100%; }
        .cyber-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }

        .btn {
            border-radius: 12px; border: none; padding: 12px 20px; cursor: pointer;
            font-weight: 600; font-family: 'Outfit', sans-serif; font-size: 0.85rem;
            display: inline-flex; align-items: center; gap: 8px; justify-content: center;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .btn-primary { background: var(--accent); color: white; box-shadow: 0 4px 12px var(--accent-glow); }
        .btn-primary:hover { transform: translateY(-1px); filter: brightness(1.1); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover { background: var(--border); }
        .btn-mini { padding: 6px 12px; font-size: 0.7rem; border-radius: 8px; }

        /* Login */
        #login-screen { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; background: var(--bg); }
        .login-box { padding: 50px; text-align: center; max-width: 480px; width: 90%; }
        .role-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 35px; }
        .role-card { padding: 25px 10px; border: 1px solid var(--border); border-radius: 16px; cursor: pointer; background: rgba(255,255,255,0.02); }
        .role-card:hover { border-color: var(--accent); background: rgba(99, 102, 241, 0.1); transform: translateY(-5px); }
        .role-card i { font-size: 2.2rem; display: block; margin-bottom: 12px; }
        .role-card span { font-weight: 700; font-family: 'Outfit'; font-size: 0.8rem; color: var(--text-dim); }

        /* Layout */
        #app-layout { display: none; height: 100vh; flex-direction: row; padding: 15px; gap: 15px; }
        .sidebar { width: 280px; display: flex; flex-direction: column; gap: 15px; flex-shrink: 0; }
        .main-view { flex: 1; display: grid; grid-template-columns: 1fr 360px; gap: 15px; height: 100%; overflow: hidden; }

        /* Timeline */
        .timeline { display: flex; flex-direction: column; overflow: hidden; }
        .timeline-header { padding: 18px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .stream-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }

        .msg-card { width: 100%; max-width: 440px; border-radius: 20px; border: 1px solid var(--border); background: rgba(255,255,255,0.02); overflow: hidden; }
        .msg-card.in { align-self: flex-start; border-left: 4px solid var(--accent); }
        .msg-card.out { align-self: flex-end; border-right: 4px solid var(--accent); }
        .msg-card.selected { border: 2px solid var(--success); }

        .msg-header { padding: 12px 15px; background: rgba(255,255,255,0.05); font-size: 0.75rem; display: flex; justify-content: space-between; color: var(--text-dim); }
        .msg-body { padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        .card-edit-inv { background: transparent; border: none; color: var(--accent); font-weight: 700; font-size: 1.2rem; width: 100%; font-family: 'Outfit'; }
        .card-edit-cap { background: rgba(0,0,0,0.3); border: 1px solid transparent; color: var(--text-dim); font-size: 0.85rem; width: 100%; padding: 10px; border-radius: 10px; resize: none; height: 70px; }

        .thumb-row-wrap { display: flex; align-items: center; gap: 12px; background: rgba(255,255,255,0.03); padding: 10px; border-radius: 12px; }
        .thumb-box { width: 65px; height: 65px; background: #000; border-radius: 10px; overflow: hidden; border: 1px solid var(--border); position: relative; }
        .thumb-box img { width: 100%; height: 100%; object-fit: contain; }

        /* Panels */
        .control-panel { overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .job-row { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 16px; padding: 18px; position: relative; }
        .job-row.checked { border-color: var(--success); background: rgba(16, 185, 129, 0.05); }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal-box { max-height: 95vh; overflow-y: auto; }

        /* Misc */
        .status-widget { padding: 15px; border-radius: 12px; border: 1px solid var(--border); background: rgba(0,0,0,0.3); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; background: #64748b; }
        .online .status-dot { background: var(--success); box-shadow: 0 0 12px var(--success); }
        .batch-bar { padding: 12px 20px; background: rgba(16, 185, 129, 0.15); border-bottom: 1px solid var(--success); display: none; justify-content: space-between; align-items: center; border-radius: 16px 16px 0 0; }
        .pdf-tag { position: absolute; bottom: 2px; right: 2px; background: #f43f5e; color: white; font-size: 8px; padding: 1px 4px; font-weight: bold; border-radius: 4px; }
    </style>
</head>
<body>

    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>
    <audio id="conn-sound" src="https://assets.mixkit.co/active_storage/sfx/1084/1084-preview.mp3"></audio>

    <!-- SCREEN: LOGIN -->
    <div id="login-screen">
        <div class="login-box glass-panel">
            <h1 style="font-family: 'Outfit'; font-size: 2.8rem; margin: 0; background: linear-gradient(to right, #6366f1, #10b981); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">KERTASES PRO</h1>
            <p style="color: var(--text-dim); font-size: 0.9rem; letter-spacing: 4px; margin-bottom: 40px;">STABLE VISIONARY EDITION</p>
            
            <div class="role-grid">
                <div class="role-card" onclick="enterRole('admin')"><i>üï∂Ô∏è</i><span>ADMIN</span></div>
                <div class="role-card" onclick="enterRole('designer')"><i>üé®</i><span>DESIGNER</span></div>
                <div class="role-card" onclick="enterRole('operator')"><i>üñ®Ô∏è</i><span>OPERATOR</span></div>
            </div>

            <div style="margin-top: 40px; display: flex; gap: 12px; justify-content: center;">
                <button id="btn-cloud" class="btn btn-primary" onclick="setMode('cloud')">CLOUD</button>
                <button id="btn-local" class="btn btn-outline" onclick="setMode('local')">LOCAL LAN</button>
            </div>
            <input type="text" id="server-ip" class="cyber-input" placeholder="IP Server (Ex: 192.168.1.5)" style="display:none; margin-top:15px; text-align:center;">
        </div>
    </div>

    <!-- SCREEN: MAIN -->
    <div id="app-layout">
        <div class="sidebar glass-panel">
            <div style="padding: 25px; text-align: center;">
                <div id="active-role-display" class="btn btn-primary btn-mini" style="pointer-events: none; border-radius: 30px; padding: 6px 20px;">---</div>
                <div id="status-widget" class="status-widget" style="margin-top: 25px; text-align: left;">
                    <div style="font-weight: 700; font-size: 0.85rem; display: flex; align-items: center;">
                        <span class="status-dot"></span> <span id="status-text">OFFLINE</span>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--text-dim); margin-top: 10px; cursor: pointer; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 10px;" onclick="changeId()">
                        MY ID: <span id="my-id-display" style="color: var(--accent); font-weight: bold; font-family: 'Roboto Mono';">...</span>
                    </div>
                </div>
            </div>

            <div style="padding: 0 20px;">
                <label style="font-size: 0.7rem; color: var(--text-dim); display: block; margin-bottom: 8px;">TARGET ID:</label>
                <input type="text" id="target-id" class="cyber-input" placeholder="Paste ID partner...">
                <button class="btn btn-primary" style="width:100%; margin-top:12px;" onclick="connectMulti()">LINK CONNECT</button>
            </div>
            
            <div id="active-conns" style="padding: 15px 20px; flex: 1; overflow-y: auto;"></div>
            
            <div style="padding: 20px; border-top: 1px solid var(--border);">
                <button class="btn btn-outline" style="width: 100%; color: var(--accent); border-color: var(--accent);" onclick="toggleHistory()">PRODUCTION LOG</button>
                <button class="btn btn-mini btn-outline" style="width: 100%; margin-top: 10px; border:none; opacity: 0.5;" onclick="location.reload()">LOGOUT</button>
            </div>
        </div>

        <div class="main-view">
            <div class="timeline glass-panel">
                <div id="batch-bar" class="batch-bar">
                    <span id="batch-count">0 ITEM DIPILIH</span>
                    <button class="btn btn-success btn-mini" onclick="openBatchPrint()">PROSES BATCH PDF</button>
                </div>
                <div class="timeline-header">
                    <span style="font-weight: 700; font-family: 'Outfit';">TIMELINE FLOW</span>
                    <button class="btn btn-danger btn-mini" onclick="clearTimeline()">CLEAR ALL</button>
                </div>
                <div id="stream-area" class="stream-area"></div>
            </div>

            <div class="control-panel glass-panel">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: 700; font-family: 'Outfit';">TRANSMIT ASSETS</span>
                    <button class="btn btn-mini btn-outline" onclick="toggleSelectAllRows()">SELECT ALL</button>
                </div>
                <div id="job-list" style="display: flex; flex-direction: column; gap: 15px;"></div>
                <button class="btn btn-outline" style="border-style: dashed; width: 100%; border-radius: 16px;" onclick="addNewJob()">+ ADD DATA ROW</button>
                <button id="btn-action-main" class="btn btn-primary" style="width: 100%; height: 55px; border-radius: 16px;" onclick="mainAction()">PROCESS SELECTED</button>
                <input type="file" id="job-file-in" multiple style="display:none;" onchange="handleFileSelect(this)">
            </div>
        </div>
    </div>

    <!-- MODAL: PRINT SETUP -->
    <div id="modal-print" class="modal">
        <div class="modal-box glass-panel" style="width: 720px; padding: 35px;">
            <h2 style="font-family: 'Outfit'; margin-top: 0;">Production Setup</h2>
            
            <div class="print-mode-tabs">
                <button id="mode-full-btn" class="print-mode-btn active" onclick="switchPrintMode('full')">üìÑ Full Page</button>
                <button id="mode-grid-btn" class="print-mode-btn" onclick="switchPrintMode('grid')">üî≤ Grid Tile</button>
            </div>

            <div style="display: flex; gap: 25px; margin-bottom: 30px;">
                <div class="glass-panel" style="width: 160px; height: 160px; display: flex; align-items: center; justify-content: center; background: #000; overflow: hidden; position: relative;">
                    <img id="p-img" style="width: 100%; height: 100%; object-fit: contain;">
                    <div id="p-pdf-badge" class="pdf-tag" style="display:none;">PDF</div>
                </div>
                <div style="flex: 1; display: flex; flex-direction: column; gap: 15px;">
                    <div>
                        <label style="font-size: 0.75rem; color: var(--text-dim);">INVOICE</label>
                        <input type="text" id="p-inv-edit" class="cyber-input" style="color: var(--warning); font-weight: 700; font-size: 1.1rem;">
                    </div>
                    <div>
                        <label style="font-size: 0.75rem; color: var(--text-dim);">BAHAN MATERIAL</label>
                        <select id="p-mat" class="cyber-input">
                            <option>Chromo</option><option>Vinyl Glossy</option><option>Vinyl Matte</option><option>Transparan</option><option>Art Carton</option><option>HVS</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="glass-panel" style="padding: 25px; background: rgba(0,0,0,0.25);">
                <div style="margin-bottom: 20px;">
                    <label style="font-size: 0.75rem; color: var(--text-dim);">MEDIA UKURAN KERTAS</label>
                    <select id="p-pdf-paper" class="cyber-input" onchange="toggleCustomPaper(this.value)">
                        <option value="32,48">A3+ (32 x 48 cm)</option><option value="29.7,42">A3 Standard</option><option value="21,29.7">A4 Standard</option><option value="custom">-- CUSTOM SIZE --</option>
                    </select>
                    <div id="custom-paper-box" style="display:none; gap: 12px; margin-top: 15px;">
                        <input type="number" id="p-custom-w" class="cyber-input" placeholder="W (cm)" oninput="calcGrid()">
                        <input type="number" id="p-custom-h" class="cyber-input" placeholder="H (cm)" oninput="calcGrid()">
                    </div>
                </div>

                <div id="grid-controls" style="display:none; border-top: 1px solid var(--border); padding-top: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: flex-end;">
                        <div><label style="font-size: 0.7rem; color: var(--text-dim);">L (cm)</label><input type="number" id="p-grid-w" value="5" step="0.1" class="cyber-input" oninput="calcGrid()"></div>
                        <div><label style="font-size: 0.7rem; color: var(--text-dim);">T (cm)</label><input type="number" id="p-grid-h" value="5" step="0.1" class="cyber-input" oninput="calcGrid()"></div>
                        <div><label style="font-size: 0.7rem; color: var(--text-dim);">GAP</label><input type="number" id="p-grid-gap" value="0" step="0.1" class="cyber-input" oninput="calcGrid()"></div>
                        <button class="btn btn-outline" style="height: 42px;" onclick="physicalRotate()">üîÑ</button>
                    </div>
                    <div id="grid-res-box" style="text-align: center; color: var(--success); font-size: 0.9rem; margin-top: 15px; font-weight: 700;">HASIL: - pcs/lbr</div>
                </div>

                <div style="margin-top: 25px;">
                    <label style="font-size: 0.8rem; color: var(--text-dim); display: block; text-align: center; margin-bottom: 5px;">QUANTITY (LEMBAR)</label>
                    <input type="number" id="p-pdf-target" value="1" class="cyber-input" style="font-size: 2rem; text-align: center; color: var(--success); font-weight: 800; font-family: 'Outfit';" oninput="calcGrid()">
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-top: 35px;">
                <button class="btn btn-danger" onclick="closeModal()">BATAL</button>
                <button id="btn-do-print" class="btn btn-primary" onclick="executePrint()">MULAI CETAK</button>
            </div>
        </div>
    </div>

    <!-- MODAL: HISTORY -->
    <div id="modal-hist" class="modal">
        <div class="modal-box glass-panel" style="width: 90%; max-width: 1100px; padding: 35px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="font-family: 'Outfit'; margin: 0;">Log System - <span id="hist-role-title" style="color: var(--accent);">...</span></h2>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-mini btn-success" onclick="exportHistory()">EXPORT CSV</button>
                    <button class="btn btn-mini btn-danger" onclick="clearAllHistory()">CLEAR LOG</button>
                </div>
            </div>
            
            <div class="hist-tabs" style="display: flex; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 12px; margin-bottom: 20px;">
                <button class="hist-tab-btn active" id="tab-1" onclick="switchHistTab(1)" style="flex:1; border:none; padding:10px; border-radius:8px; cursor:pointer;">TAB 1</button>
                <button class="hist-tab-btn" id="tab-2" onclick="switchHistTab(2)" style="flex:1; border:none; padding:10px; border-radius:8px; cursor:pointer;">TAB 2</button>
            </div>

            <div style="max-height: 500px; overflow-y: auto;" class="glass-panel">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="padding: 15px; text-align: left;">WAKTU</th>
                            <th style="text-align:center;">FOTO</th>
                            <th>INV</th>
                            <th style="text-align:center;">QTY</th>
                            <th>KET</th>
                            <th>PARTNER</th>
                            <th>AKSI</th>
                        </tr>
                    </thead>
                    <tbody id="hist-body"></tbody>
                </table>
            </div>
            <button class="btn btn-outline" style="width: 100%; margin-top: 30px;" onclick="toggleHistory()">CLOSE LOG</button>
        </div>
    </div>

    <iframe id="p-frame" style="display:none;"></iframe>

    <script>
        const ROLES_KEYS = { admin: "calik", designer: "melengkung", operator: "nangtung" };
        let cfg = { mode: 'cloud', host: 'localhost' };
        let myId = localStorage.getItem('kts_id') || 'KTS-' + Math.floor(Math.random()*9999);
        let role, peer, db, activeConns = [], currentTab = 1, activeJob = null;
        let tempJobs = [], activeJobIdx = null, selectedInboxes = [], currentPrintMode = 'full';

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let req = indexedDB.open("KertasesV14_1_DB", 1);
        req.onupgradeneeded = e => {
            let d = e.target.result;
            d.createObjectStore("stream", { keyPath: "id" });
            d.createObjectStore("history", { keyPath: "id", autoIncrement:true });
        };
        req.onsuccess = e => db = e.target.result;

        function enterRole(r) {
            const pass = prompt(`KODE AKSES ${r.toUpperCase()}:`);
            if(pass === ROLES_KEYS[r]) {
                role = r;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-layout').style.display = 'flex';
                document.getElementById('active-role-display').innerText = role.toUpperCase();
                document.getElementById('my-id-display').innerText = myId;
                if(role === 'operator') {
                    document.getElementById('batch-bar').style.display = 'flex';
                    document.getElementById('btn-action-main').innerText = "CETAK DATA (SELECTED)";
                }
                initPeer(); addNewJob(); setTimeout(renderStream, 500);
            } else if (pass !== null) alert("DENIED");
        }

        function setMode(m) {
            cfg.mode = m;
            document.getElementById('btn-cloud').className = m==='cloud' ? 'btn btn-primary' : 'btn btn-outline';
            document.getElementById('btn-local').className = m==='local' ? 'btn btn-primary' : 'btn btn-outline';
            document.getElementById('server-ip').style.display = m==='local'?'block':'none';
        }

        function initPeer() {
            const opts = (cfg.mode === 'local') ? { host: document.getElementById('server-ip').value || 'localhost', port: 9000, path: '/kertases-app' } : { debug: 1 };
            peer = new Peer(myId, opts);
            peer.on('open', () => updateStatus('ready'));
            peer.on('connection', c => setupConn(c));
            peer.on('error', err => { if(err.type === 'peer-unavailable') alert("Target Offline!"); updateStatus('offline'); });
        }

        function connectMulti() {
            const tid = document.getElementById('target-id').value.trim();
            if(!tid || tid === myId) return alert("ID Salah!");
            updateStatus('connecting...');
            setupConn(peer.connect(tid, { reliable: true }));
        }

        function setupConn(c) {
            c.on('open', () => {
                if(!activeConns.find(x => x.peer === c.peer)) {
                    activeConns.push(c); updateStatus('online'); updateConnUI();
                    document.getElementById('conn-sound').play().catch(()=>{});
                }
            });
            c.on('data', d => { if(d.type === 'job') handleIncoming(d, c.peer); });
            c.on('close', () => { 
                activeConns = activeConns.filter(x => x.peer !== c.peer); 
                updateConnUI(); if(!activeConns.length) updateStatus('ready'); 
            });
        }

        function updateConnUI() { document.getElementById('active-conns').innerHTML = activeConns.map(x => `<div class="glass-panel" style="padding:8px 12px; margin-bottom:8px; font-size:0.75rem; border-color:var(--success);">üü¢ ${x.peer}</div>`).join(''); }
        
        function updateStatus(s) { 
            const w = document.getElementById('status-widget');
            w.className = 'status-widget ' + (activeConns.length > 0 ? 'online' : s);
            document.getElementById('status-text').innerText = activeConns.length > 0 ? 'CONNECTED' : s.toUpperCase();
        }

        function addNewJob() { tempJobs.push({ files: [], inv: '', cap: '', selected: true }); renderJobs(); }
        function triggerFileSelect(idx) { activeJobIdx = idx; document.getElementById('job-file-in').click(); }
        async function handleFileSelect(input) {
            if(!input.files.length || activeJobIdx === null) return;
            for(let f of input.files) {
                let isPdf = f.type === 'application/pdf';
                let data = await toBase64(f);
                let thumb = isPdf ? await getPdfPreview(data) : data;
                tempJobs[activeJobIdx].files.push({ data, thumb, isPdf, name: f.name });
            }
            renderJobs(); input.value = '';
        }

        function renderJobs() {
            const list = document.getElementById('job-list'); list.innerHTML = '';
            tempJobs.forEach((job, jIdx) => {
                let row = document.createElement('div');
                row.className = `job-row ${job.selected ? 'checked' : ''}`;
                let thumbs = job.files.map((f, fIdx) => `<div class="thumb-box"><img src="${f.thumb}">${f.isPdf ? '<div class="pdf-tag">PDF</div>':''}<div onclick="removeFile(${jIdx}, ${fIdx})" style="position:absolute; top:2px; left:2px; background:var(--danger); color:white; font-size:10px; padding:2px; cursor:pointer; border-radius:50%; width:16px; height:16px; text-align:center; line-height:12px;">√ó</div></div>`).join('');
                row.innerHTML = `
                    <input type="checkbox" style="position:absolute; top:15px; right:15px; transform:scale(1.4);" ${job.selected ? 'checked' : ''} onchange="tempJobs[${jIdx}].selected=this.checked; renderJobs()">
                    <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:15px;">${thumbs}<div class="thumb-box" style="cursor:pointer; border:1px dashed var(--accent); color:var(--accent); display:flex; align-items:center; justify-content:center; font-size:1.8rem;" onclick="triggerFileSelect(${jIdx})">+</div></div>
                    <input type="text" class="cyber-input" placeholder="No Invoice" value="${job.inv}" oninput="tempJobs[${jIdx}].inv=this.value" style="margin-bottom:10px; border-color:rgba(255,255,255,0.05); background:transparent; font-weight:700;">
                    <textarea class="cyber-input" placeholder="Keterangan pekerjaan..." oninput="tempJobs[${jIdx}].cap=this.value" style="background:transparent; border-color:rgba(255,255,255,0.05);">${job.cap}</textarea>
                    <button class="btn btn-mini btn-danger btn-outline" style="width:100%; margin-top:15px; border-color:rgba(244,63,94,0.2);" onclick="removeJob(${jIdx})">HAPUS BARIS INI</button>
                `;
                list.appendChild(row);
            });
        }

        function removeFile(jIdx, fIdx) { tempJobs[jIdx].files.splice(fIdx, 1); renderJobs(); }
        function removeJob(idx) { tempJobs.splice(idx, 1); renderJobs(); }
        function toggleSelectAllRows() { let all = tempJobs.every(j => j.selected); tempJobs.forEach(j => j.selected = !all); renderJobs(); }

        function mainAction() {
            const sel = tempJobs.filter(j => j.selected);
            if(!sel.length) return alert("Pilih data nu bade dipros√©s!");
            
            if(role === 'operator') {
                let files = []; 
                sel.forEach(j => j.files.forEach(f => files.push({...f, inv: j.inv})));
                if(!files.length) return alert("Henteu aya file!");
                openPrintLogic({ files }); // Ieu nu tadi teu fungsi
            } else {
                if(!activeConns.length) return alert("Hubungkeun ka Target ID heula!");
                let d = { type: 'job', jobs: sel, id: Date.now(), senderRole: role, senderId: myId };
                activeConns.forEach(c => { if(c.open) c.send(d); });
                saveStream({ ...d, direction: 'out', hidden: false });
                sel.forEach(job => saveHistory({ inv: job.inv, cap: job.cap, thumb: job.files[0]?.thumb, typeLabel: role==='admin'?'ADM_SEND':'DSN_SEND', partner: activeConns.map(c=>c.peer).join(', ') }));
                alert("DATA TOS TERKIRIM!"); 
                tempJobs = tempJobs.filter(j => !j.selected); if(!tempJobs.length) addNewJob(); renderJobs(); renderStream();
            }
        }

        function handleIncoming(d, from) {
            let label = (role==='designer') ? "DSN_RECV" : (role==='operator') ? "OP_RECV" : "ADM_RECV";
            saveStream({ ...d, direction: 'in', from: from, hidden: false });
            d.jobs.forEach(job => saveHistory({ inv: job.inv, cap: job.cap, thumb: job.files[0]?.thumb, typeLabel: label, partner: from }));
            renderStream(); document.getElementById('notif-sound').play().catch(()=>{});
        }

        function renderStream() {
            const area = document.getElementById('stream-area'); area.innerHTML = '';
            db.transaction("stream").objectStore("stream").getAll().onsuccess = e => {
                e.target.result.forEach(msg => {
                    if(msg.hidden || (role==='admin' && msg.direction==='in') || (role==='operator' && msg.direction==='out')) return;
                    let card = document.createElement('div');
                    card.className = `msg-card ${msg.direction} ${selectedInboxes.includes(msg.id) ? 'selected' : ''}`;
                    let header = `<div class="msg-header"><span>SENDER: ${msg.from || 'ME'}</span><span onclick="hideStream(${msg.id})" style="cursor:pointer; color:var(--danger); font-weight:800;">√ó</span></div>`;
                    let body = document.createElement('div'); body.className = 'msg-body';
                    
                    msg.jobs.forEach((job, jIdx) => {
                        let jobWrap = document.createElement('div');
                        jobWrap.style.marginBottom = "15px";
                        jobWrap.innerHTML = `
                            <input type="text" class="card-edit-inv" value="${job.inv||''}" onchange="updateStreamContent(${msg.id}, ${jIdx}, 'inv', this.value)">
                            <textarea class="card-edit-cap" onchange="updateStreamContent(${msg.id}, ${jIdx}, 'cap', this.value)">${job.cap||''}</textarea>
                        `;
                        job.files.forEach((f, fIdx) => {
                            let fWrap = document.createElement('div'); fWrap.className = 'thumb-row-wrap';
                            fWrap.innerHTML = `
                                <div class="thumb-box"><img src="${f.thumb}">${f.isPdf?'<div class="pdf-tag">PDF</div>':''}</div>
                                <button class="btn btn-mini btn-outline" style="color:var(--success); border-color:rgba(16,185,129,0.2); flex:1;" onclick="downloadAsset('${f.data}', '${job.inv||'file'}_${fIdx}')">üíæ SAVE FILE</button>
                            `;
                            jobWrap.appendChild(fWrap);
                        });
                        body.appendChild(jobWrap);
                    });
                    
                    let footer = document.createElement('div'); footer.style.cssText = "padding:12px; display:flex; gap:10px; border-top:1px solid var(--border);";
                    if(msg.direction==='in' && role==='operator') {
                        footer.innerHTML = `
                            <button class="btn btn-success btn-mini" style="flex:2;" onclick="openPrintSingle(${msg.id})">CETAK</button>
                            <button class="btn btn-outline btn-mini" style="flex:1;" onclick="toggleSelect(${msg.id})">BATCH</button>
                        `;
                    }
                    card.innerHTML = header; card.appendChild(body); card.appendChild(footer);
                    area.appendChild(card);
                });
                area.scrollTop = area.scrollHeight;
            };
        }

        function updateStreamContent(msgId, jobIdx, field, value) {
            db.transaction("stream", "readwrite").objectStore("stream").get(msgId).onsuccess = e => {
                let d = e.target.result; d.jobs[jobIdx][field] = value;
                db.transaction("stream", "readwrite").objectStore("stream").put(d);
            };
        }

        // --- PRINT ENGINE ---
        function switchPrintMode(m) {
            currentPrintMode = m;
            document.getElementById('mode-full-btn').className = `print-mode-btn ${m==='full'?'active':''}`;
            document.getElementById('mode-grid-btn').className = `print-mode-btn ${m==='grid'?'active':''}`;
            document.getElementById('grid-controls').style.display = (m === 'grid') ? 'block' : 'none';
            calcGrid();
        }

        function openPrintSingle(id) {
            db.transaction("stream").objectStore("stream").get(id).onsuccess = e => {
                let d = e.target.result, files = [];
                d.jobs.forEach(j => j.files.forEach(f => files.push({...f, inv: j.inv})));
                openPrintLogic({ files });
            };
        }

        function openPrintLogic(job) {
            activeJob = job;
            document.getElementById('modal-print').style.display = 'flex';
            document.getElementById('p-img').src = job.files[0].thumb;
            document.getElementById('p-pdf-badge').style.display = job.files[0].isPdf ? 'block' : 'none';
            document.getElementById('p-inv-edit').value = job.files[0].inv;
            switchPrintMode(job.files[0].isPdf ? 'full' : 'grid');
        }

        function toggleCustomPaper(val) { document.getElementById('custom-paper-box').style.display = (val === 'custom') ? 'flex' : 'none'; calcGrid(); }

        function calcGrid() {
            if(currentPrintMode !== 'grid') { document.getElementById('grid-res-box').style.display = 'none'; return; }
            document.getElementById('grid-res-box').style.display = 'block';
            let pw, ph;
            if(document.getElementById('p-pdf-paper').value === 'custom') {
                pw = parseFloat(document.getElementById('p-custom-w').value) || 0;
                ph = parseFloat(document.getElementById('p-custom-h').value) || 0;
            } else {
                let p = document.getElementById('p-pdf-paper').value.split(',');
                pw = parseFloat(p[0]); ph = parseFloat(p[1]);
            }
            let w = parseFloat(document.getElementById('p-grid-w').value) || 1;
            let h = parseFloat(document.getElementById('p-grid-h').value) || 1;
            let gap = parseFloat(document.getElementById('p-grid-gap').value) || 0;
            let target = parseInt(document.getElementById('p-pdf-target').value) || 1;
            let nx = Math.floor((pw + gap) / (w + gap));
            let ny = Math.floor((ph + gap) / (h + gap));
            document.getElementById('grid-res-box').innerText = `ESTIMASI: ${nx * ny} pcs/lbr | TOTAL: ${nx * ny * target} PCS`;
        }

        async function physicalRotate() {
            let f = activeJob.files[0]; if(f.isPdf) return;
            let img = new Image(); img.src = f.data; await img.decode();
            let cvs = document.createElement('canvas'); cvs.width = img.height; cvs.height = img.width;
            let ctx = cvs.getContext('2d'); ctx.translate(cvs.width/2, cvs.height/2); ctx.rotate(90 * Math.PI / 180);
            ctx.drawImage(img, -img.width/2, -img.height/2);
            f.data = f.thumb = cvs.toDataURL('image/jpeg', 0.9);
            document.getElementById('p-img').src = f.thumb;
            let ow = document.getElementById('p-grid-w').value;
            document.getElementById('p-grid-w').value = document.getElementById('p-grid-h').value;
            document.getElementById('p-grid-h').value = ow;
            calcGrid();
        }

        function executePrint() { if(currentPrintMode === 'full') executeFullPrint(); else executeGridPrint(); }

        async function executeFullPrint() {
            const btn = document.getElementById('btn-do-print'); btn.innerText = "RENDERING..."; btn.disabled = true;
            try {
                let pw, ph;
                if(document.getElementById('p-pdf-paper').value === 'custom') {
                    pw = document.getElementById('p-custom-w').value; ph = document.getElementById('p-custom-h').value;
                } else {
                    let p = document.getElementById('p-pdf-paper').value.split(','); pw = p[0]; ph = p[1];
                }
                let target = parseInt(document.getElementById('p-pdf-target').value) || 1;
                let mat = document.getElementById('p-mat').value, inv = document.getElementById('p-inv-edit').value;
                let html = `<style>@page { size: ${pw}cm ${ph}cm; margin: 0; } body { margin: 0; } .sheet { width: ${pw}cm; height: ${ph}cm; page-break-after: always; display: flex; flex-direction: column; align-items: center; justify-content: center; } .p-img { width: 100%; height: calc(100% - 1.2cm); object-fit: contain; } .footer { height: 1.2cm; font-size: 11pt; font-family: sans-serif; font-weight: bold; display: flex; align-items: center; justify-content: center; border-top: 1px solid #eee; }</style>`;
                let content = "";
                for(let f of activeJob.files) {
                    const img = f.isPdf ? await getPdfPreview(f.data, true) : f.data;
                    for(let i=0; i<target; i++) content += `<div class="sheet"><img src="${img}" class="p-img"><div class="footer">${inv} - ${mat}</div></div>`;
                }
                printIframe(html + content, inv, target, 'FULL PAGE');
            } catch(e) { alert("Error!"); btn.innerText = "MULAI CETAK"; btn.disabled = false; }
        }

        function executeGridPrint() {
            const btn = document.getElementById('btn-do-print'); btn.innerText = "PROSES GRID..."; btn.disabled = true;
            let pw, ph;
            if(document.getElementById('p-pdf-paper').value === 'custom') {
                pw = parseFloat(document.getElementById('p-custom-w').value); ph = parseFloat(document.getElementById('p-custom-h').value);
            } else {
                let p = document.getElementById('p-pdf-paper').value.split(','); pw = parseFloat(p[0]); ph = parseFloat(p[1]);
            }
            let w = parseFloat(document.getElementById('p-grid-w').value), h = parseFloat(document.getElementById('p-grid-h').value);
            let gap = parseFloat(document.getElementById('p-grid-gap').value) || 0;
            let target = parseInt(document.getElementById('p-pdf-target').value) || 1;
            let inv = document.getElementById('p-inv-edit').value, mat = document.getElementById('p-mat').value;
            
            let nx = Math.floor((pw + gap) / (w + gap));
            let ny = Math.floor((ph + gap) / (h + gap));
            let halfGap = gap / 2;

            const mk = (t, l, dir) => {
                let hStyle = `position:absolute; top:-0.1mm; width:5mm; height:0.2mm; background:#000;`;
                let vStyle = `position:absolute; left:-0.1mm; width:0.2mm; height:5mm; background:#000;`;
                let parts = "";
                if(dir.includes('r')) parts += `<div style="${hStyle} left:0;"></div>`;
                if(dir.includes('l')) parts += `<div style="${hStyle} left:-5mm;"></div>`;
                if(dir.includes('d')) parts += `<div style="${vStyle} top:0;"></div>`;
                if(dir.includes('u')) parts += `<div style="${vStyle} top:-5mm;"></div>`;
                return `<div style="position:absolute; top:${t}; left:${l}; width:0; height:0; z-index:100;">${parts}</div>`;
            };

            let html = `<style>@page { size: ${pw}cm ${ph}cm; margin: 0; } body { margin: 0; } .sheet { width: ${pw}cm; height: ${ph}cm; display: flex; align-items: center; justify-content: center; page-break-after: always; position: relative; } .grid-container { display: grid; grid-template-columns: repeat(${nx}, ${w}cm); grid-gap: ${gap}cm; position: relative; } .cell { position: relative; width: ${w}cm; height: ${h}cm; overflow: visible; } .cell img { width: 100%; height: 100%; object-fit: fill; } .footer { position: absolute; bottom: 0.3cm; width: 100%; text-align: center; font-weight: bold; font-family: sans-serif; font-size: 10pt; }</style>`;

            let cells = ""; 
            for(let row=0; row<ny; row++) {
                for(let col=0; col<nx; col++) {
                    let offset = halfGap > 0 ? `-${halfGap}cm` : "0";
                    const getType = (r, c) => {
                        if(r===0 && c===0) return "rd"; if(r===0 && c===nx) return "ld";
                        if(r===ny && c===0) return "ru"; if(r===ny && c===nx) return "lu";
                        if(r===0) return "lrd"; if(r===ny) return "lru";
                        if(c===0) return "rdu"; if(c===nx) return "ldu";
                        return "lrdu";
                    };
                    let marks = mk(offset, offset, getType(row, col));
                    if(col === nx-1) marks += mk(offset, `calc(100% + ${halfGap}cm)`, getType(row, col+1));
                    if(row === ny-1) {
                        marks += mk(`calc(100% + ${halfGap}cm)`, offset, getType(row+1, col));
                        if(col === nx-1) marks += mk(`calc(100% + ${halfGap}cm)`, `calc(100% + ${halfGap}cm)`, getType(row+1, col+1));
                    }
                    cells += `<div class="cell"><img src="${activeJob.files[0].data}">${marks}</div>`;
                }
            }
            let content = ""; 
            for(let i=0; i<target; i++) content += `<div class="sheet"><div class="grid-container">${cells}</div><div class="footer">${inv} - ${mat}</div></div>`;
            printIframe(html + content, inv, target, `GRID (${nx*ny}x${target})`);
        }

        function printIframe(fullHtml, inv, qty, mode) {
            let f = document.getElementById('p-frame'); f.style.display = "block";
            f.contentWindow.document.open(); f.contentWindow.document.write(fullHtml); f.contentWindow.document.close();
            setTimeout(() => {
                f.contentWindow.print(); f.style.display = "none";
                let btnId = document.getElementById('btn-do-print'); btnId.innerText = "MULAI CETAK"; btnId.disabled = false;
                saveHistory({ inv, typeLabel: 'OP_PROD', qty, cap: mode, thumb: activeJob.files[0].thumb, partner: 'LOKAL' });
                closeModal();
            }, 1000);
        }

        // --- GLOBAL UTILS ---
        function saveHistory(obj) { db.transaction("history", "readwrite").objectStore("history").add({ time: new Date().toLocaleString(), inv: obj.inv || '-', cap: obj.cap || '-', partner: obj.partner || '?', typeLabel: obj.typeLabel, role: role, qty: obj.qty || 1, thumb: obj.thumb || null }); }
        
        function refreshHistBody() {
            const b = document.getElementById('hist-body'); b.innerHTML = '';
            db.transaction("history").objectStore("history").getAll().onsuccess = e => {
                e.target.result.reverse().forEach(h => {
                    let show = false;
                    if(role === 'admin' && h.typeLabel === 'ADM_SEND') show = true;
                    else if(role === 'designer') {
                        if(currentTab === 1 && h.typeLabel === 'DSN_RECV') show = true;
                        if(currentTab === 2 && h.typeLabel === 'DSN_SEND') show = true;
                    } else if(role === 'operator') {
                        if(currentTab === 1 && h.typeLabel === 'OP_RECV') show = true;
                        if(currentTab === 2 && h.typeLabel === 'OP_PROD') show = true;
                    }
                    if(show) {
                        let im = h.thumb ? `<img src="${h.thumb}" style="width:45px; height:45px; object-fit:contain; background:#000; border-radius:8px; border:1px solid var(--border);">` : '-';
                        b.innerHTML += `
                        <tr>
                            <td style="padding:15px; font-size:0.7rem; color:var(--text-dim);">${h.time}</td>
                            <td style="text-align:center;">${im}</td>
                            <td style="color:var(--accent); font-weight:700;">${h.inv}</td>
                            <td style="text-align:center; color:var(--success); font-weight:800;">${h.qty}</td>
                            <td style="font-size:0.75rem;">${h.cap}</td>
                            <td style="color:var(--text-dim);">${h.partner}</td>
                            <td><button class="btn btn-mini btn-danger btn-outline" style="border:none;" onclick="deleteHistory(${h.id})">DEL</button></td>
                        </tr>`;
                    }
                });
            };
        }

        function setupHistoryTabs() {
            const t1 = document.getElementById('tab-1'), t2 = document.getElementById('tab-2');
            currentTab = 1; t1.className = 'hist-tab-btn active'; t2.className = 'hist-tab-btn';
            if(role === 'admin') { t1.innerText = "LOG TERKIRIM"; t2.style.display = 'none'; }
            else if(role === 'designer') { t1.innerText = "INBOX (DARI ADM)"; t2.innerText = "OUTBOX (KE OP)"; t2.style.display = 'block'; }
            else if(role === 'operator') { t1.innerText = "INBOX (MASUK)"; t2.innerText = "RIWAYAT CETAK"; t2.style.display = 'block'; }
        }

        function switchHistTab(n) { currentTab = n; document.getElementById('tab-1').classList.toggle('active', n===1); document.getElementById('tab-2').classList.toggle('active', n===2); refreshHistBody(); }
        function deleteHistory(id) { db.transaction("history", "readwrite").objectStore("history").delete(id).onsuccess = () => refreshHistBody(); }
        function clearAllHistory() { if(confirm("Hapus sadaya log history milik anjeun?")) { let tx = db.transaction("history", "readwrite"); tx.objectStore("history").openCursor().onsuccess = e => { let c = e.target.result; if(c && c.value.role === role) c.delete(); c?.continue(); }; setTimeout(refreshHistBody, 300); } }
        function toggleHistory() { let m = document.getElementById('modal-hist'); m.style.display = m.style.display==='flex'?'none':'flex'; if(m.style.display==='flex') { document.getElementById('hist-role-title').innerText = role.toUpperCase(); setupHistoryTabs(); refreshHistBody(); } }
        function downloadAsset(data, name) { const a = document.createElement('a'); a.href = data; a.download = name; a.click(); }
        function clearTimeline() { if(confirm("Hapus sadaya data dina Timeline Flow?")) { db.transaction("stream", "readwrite").objectStore("stream").clear().onsuccess = () => renderStream(); } }
        
        async function getPdfPreview(base64, high = false) {
            try {
                const pdfData = atob(base64.split(',')[1]);
                const pdf = await pdfjsLib.getDocument({data: pdfData}).promise;
                const page = await pdf.getPage(1);
                const viewport = page.getViewport({scale: high ? 3.0 : 0.5});
                const cvs = document.createElement('canvas'); cvs.height = viewport.height; cvs.width = viewport.width;
                await page.render({canvasContext: cvs.getContext('2d'), viewport: viewport}).promise;
                return cvs.toDataURL('image/jpeg', high ? 0.9 : 0.5);
            } catch(e) { return null; }
        }

        function saveStream(o) { db.transaction("stream", "readwrite").objectStore("stream").put(o); }
        function closeModal() { document.getElementById('modal-print').style.display = 'none'; }
        function hideStream(id) { db.transaction("stream", "readwrite").objectStore("stream").get(id).onsuccess = e => { let d = e.target.result; d.hidden = true; db.transaction("stream", "readwrite").objectStore("stream").put(d); renderStream(); }; }
        function toBase64(f) { return new Promise(r => { let fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(f); }); }
        function changeId() { if(prompt("ENTER PASSWORD TO CHANGE ID:") === "4869") { let nid = prompt("ENTER NEW ID:", myId); if(nid) { localStorage.setItem('kts_id', nid); location.reload(); } } else alert("WRONG PASSWORD!"); }
        function toggleSelect(id) { if(selectedInboxes.includes(id)) selectedInboxes = selectedInboxes.filter(x => x !== id); else selectedInboxes.push(id); document.getElementById('batch-count').innerText = `${selectedInboxes.length} ITEM DIPILIH`; renderStream(); }
        function openBatchPrint() { if(!selectedInboxes.length) return; let all = []; let count = 0; selectedInboxes.forEach(id => { db.transaction("stream").objectStore("stream").get(id).onsuccess = e => { e.target.result.jobs.forEach(j => j.files.forEach(f => { if(f.isPdf) all.push({...f, inv: j.inv}); })); count++; if(count === selectedInboxes.length) openPrintLogic({ files: all }); } }); }
        function exportHistory() { let csv = "WAKTU,INV,QTY,KET,PARTNER\n"; db.transaction("history").objectStore("history").getAll().onsuccess = e => { e.target.result.forEach(h => { if(h.role===role) csv += `"${h.time}","${h.inv}","${h.qty}","${h.cap}","${h.partner}"\n`; }); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download="log_kertases.csv"; a.click(); }; }
    </script>
</body>
</html>
